
さて今回はあなたが共有してくれたえーっとソフトウェア設計のリポジトリっていう概念 これを掘り下げていきたいなと思います はい 正直に言うとこういう設計パターンの話ってなんかちょっと身構えちゃうんですよね また新しいルールを覚えないといけないのかって あーわかります ただ今回取り上げるこのリポジトリっていう考え方の面白いところは まあ新しいルールってよりむしろごちゃごちゃになった部屋を片付けるための整理術に近いんですよ ほう整理術 えぇ 資料の冒頭にデータにまつわる処理を分離するとあるのはまさにそこの革新部分ですね なるほど 確かにコードを読んでるとこれ一体何がしたいんだっけって本筋を見失うことありますあります ですよね 特にビジネスの大事なルールを決めたいのになんかデータベースの接続設定みたいな技術的な詳細がごちゃっと入ってくるともうお手上げで そうなんですその本筋資料で言うところのビジネスロジックとそれを実現するための技術的な詳細これを分ける はい これがなぜ重要かそれはコードが単なる命令の並びじゃなくて未来の自分とか同僚に向けた意図を伝えるコミュニケーションだからなんです あーコミュニケーション ええそのコミュニケーションをリポジトリがどうやってクリアにしてくれるのかちょっと見ていきましょうか はいではまずそのごちゃごちゃの部屋の状態から見てみたいですリポジトリを使わない場合のコード例がありますけど ええ いやーこれはひどいですねユーザーを新しく登録するっていうだけの処理のはずなのにスイークネクションだのスイーコマンドだのなんかデータベースの専門用語がずらっと並んでて まさにここで何が問題かというと例えば同じ名前のユーザーは登録できないっていうビジネス上のこれすごく重要なルールですよね はい重要ですね それがセレクトカウントみたいなSQLの断片の中に埋もれちゃってることなんです あーなるほどこれだとそのルールがどこに書いてあるのか一目じゃ全然わかりませんね そうなんです こういうコード見たことあります一見ただのユーザー登録なのにデータベースの知識がないと読み解けないこれだとビジネスの担当者がやっぱり同じ名前でも登録できるようにしたいって言ってきた時に ええ もうどこを下がればいいか探すだけで1日が終わりそうです おっしゃる通りですさらに深刻なのはもし将来うちのシステムデータベースをSQLサーバーから別のものに乗り換えようなんて話になったらどうなると思いますか うわーそれは考えたくないですね ですよね ビジネスのルールが書いてあるはずの場所をデータベースの変更のために全部書き直さないといけなくなる そうソフトウェアがもうガチガチに固まっちゃって変化に対応できなくなるわけです それがこの設計が引き起こす硬直化の正体ですか はいこのカオスな状況を解決する切り札として資料が提示するのがこのリポジトリという考え方なんです なるほどビジネスロジックとデータベースの間にいわば仲介役を置くみたいなイメージでしょうか 資料では保管庫なんていう表現もされてますね ビジネスロジックはこの保管庫の受付係にこのユーザーさん預かってくださいとかこの名前の人を探してくださいってお願いするだけになると 良い例えですねただ仲介役や保管庫っていうと少しだけ誤解を招くかもしれない リポジトリは単に処理を右から左へ流すだけじゃなくてあくまでオブジェクトの集合であるかのように振る舞うっていうのがポイントなんです オブジェクトの集合はいその裏側がデータベースだろうがただのファイルだろうがビジネスロジック側には全く関係ないと完全に忘れさせてくれる この忘れさせてくれるっていうのが抽象化の本当の力ですね なるほどリポジトリを使った後のコード例を見比べて今やっと腑に落ちました ユーザーリポジトリ.セーブユーザーのたったこの一行であの複雑だったデータベースへの接続とかSQL分の実行が全部隠されている そうなんですこれは確かに後からコードを読む人にとっては天国ですやりたいことがそのままコードに書いてある ビジネスロジックはどうやって保存するかっていうハウロー世界から解放されて何をしたいかっていうウォットの世界に集中できる ここで重要なのがリポジトリをインターフェースとして定義する点なんです これはビジネスロジックとリポジトリの間で交わされる一種の約束ごとみたいなものです 約束ごとですか セーブという名前でお願いしたらちゃんと保存しておきますねっていう ビジネスロジック側はこの約束ごとさえ知っていればその裏で誰がどうやって仕事をしているのか気にする必要が一切なくなるわけです コードが綺麗になるのはよくわかりましたでも正直に言うと間に一層挟むわけじゃないですか はい かえってコードが複雑になったり処理が遅くなったりする心配はないんでしょうか それは非常に鋭い指摘ですねもちろんわずかなパフォーマンス上のオーバーヘッドは発生し得ます でもほとんどのアプリケーションにおいてその差は無視できるレベルです それ以上にこの分離がもたらす恩恵特にこれから話すメリットを考えればもうお釣りが来るほどの価値があります というとコードが読みやすくなる変更しやすくなるだけじゃないんですか この石鹸がもたらす最大のそして最も開発者を幸せにするメリットはテストが劇的に楽になることなんです テストですか 種類にもありましたけどデータベースが絡むテストって本当に悪夢ですよね ですよね まずテスト用のデータベースを準備してテーブル作ってテストが終わったらデータを元に戻してもう準備だけで疲れちゃってだんだんテストするのが億劫になってくる そして最終的にはまあ多分動くだろうって祈るようになる 資料に出てくる祈り信者のテスト理論という言葉あまりに的確で笑ってしまいました 本当に朱雲な表現ですよね でリポジトリがどうやってこの祈りから我々を救ってくれるんですか 鍵はさっき話した約束ごとつまりインターフェースにあります ビジネスロジックは約束ごとを守ってくれる相手なら誰でもいいわけです はいそこで本番環境ではデータベースと実際に通信するリポジトリを使いますがテストの時だけメモリ上で動く偽物のリポジトリにそっくり差し替えてしまうんです 偽物のリポジトリはい資料のリスト5.13で示されているインメモリリポジトリがそれです ありましたねこれはデータベースの代わりにプログラムが動いている間だけデータを保持してくれるごく簡単な仕組みです これを使えば面倒なデータベースの準備は一切不要 ということは ボタン一つで一瞬で何度でもテストが実行できるようになる なるほどそれは革命的ですねビジネスロジックから見れば相手が本物だろうが偽物だろうが同じ約束ごとに従って動いてくれるから全く問題ないと まさにこれにより動くだろうっていう希望的観測がこのロジックは間違いなく意図通りに動作するっていう揺るぎない自信に変わります 自信ですか ソフトウェアの品質はこの自信の積み重ねでしかありません この一点だけでもリポジトリを導入する価値は十分にあると言えます なるほどなこれほど強力なパターンだとするとうまく使いこなすためのコツみたいなものもありそうですね 何でもかんでもリポジトリに任せればいいというわけではなさそうですし その通りです資料でもリポジトリに定義すべき振る舞いについて注意を促してますね リポジトリの設任はあくまでオブジェクトの集合を管理すること 集合の管理 つまりデータの保存セーブとか検索ファインドとかそういったコレクションみたいな基本的な操作に徹するべきなんです 例えばアップデートネーム名前だけを更新するみたいな特定の目的を持ったメソッドをリポジトリに作るのは悪い例だとされていますね そうなんです オブジェクトの状態を変えるならオブジェクト自身にその責任を持たせるべきでリポジトリがでしゃばるなと はい責務の分離が重要ですビジネスルールをリポジトリに実装し始まるとせっかく分離したはずの意図がまたぼやけてしまいますから なるほど リポジトリはあくまでインフラとしたの役割に徹するべきなんです もう一つ資料を読んでてなるほど深いなと思ったのがオブジェクトが見つからなかった場合に何を返すかっていう議論です なるの話ですね 普通ならなるを返しそうですけど資料ではそれを人類が取り扱うには難しい概念とまで言って警鐘鳴らしてますよね なるはプログラミングにおける長年の厄介者で多くのバグの原因になってきました 値がないという状態を示すために使われますがうっかりその存在を忘れて処理しようとするとプログラムは即座にエラーで停止してしまう そこでオプション型のような値があるかもしれないしないかもしれないという状態をより安全に表現できる仕組みを使うことが推奨されています これはもうリポジトリの設計というよりもっと広範な堅牢なソフトウェアを作るための哲学に関わる話ですね いや面白いですね今回の探究をまとめてみるとリポジトリは単なる技術的な部品じゃないと 関心ごとの分離っていうもっと大きな設計思想の具体的な表れだということがよくわかりました 何をしたいかという本質とどうやって実現するかという手段をきっぱりと切り離す まさにそのシンプルな原則がソフトウェアに柔軟性と保守性そして何よりテストに裏打ちされた信頼性をもたらすわけです 未来の自分が行動を呼んだ時に過去の自分よくやったって感謝できるような素晴らしい贈り物になるんですね その通りですそして最後にあなたに一つ考えてみてほしい問いがあります はい 今回の話はソフトウェアの世界でデータベースという具体的な技術をビジネスという本質から切り離す話でした これをあなたの仕事や日常に置き換えて考えてみるとどうでしょう 仕事や日常ですか ええあなたの本来の目標達成を妨げている本質的ではない技術的な詳細とか煩雑な手続きってありませんか 例えば毎日の報告書作成のフォーマットに悩む時間とかツールの細かい設定に費やす時間とか そこにリポジトリのような抽象的な層つまり決まった手順やテンプレートといった一種の中間役を設けることで もっと本質的な創造的な仕事に集中できるようになるかもしれない ソフトウェア設計の知恵は意外と現実世界の問題解決にも役立つんですよ