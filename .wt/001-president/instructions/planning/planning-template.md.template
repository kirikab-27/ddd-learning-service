<!-- Planning Document Template -->
<!--
  Usage: Replace all [PLACEHOLDERS] with project-specific values

  This template follows Protocol Improvement 3, which has achieved
  11+ consecutive successful completions in BookRAG Manager.

  Planning documents are created at the beginning of a project phase
  to define goals, architecture, technology choices, and milestones.
-->

# [VERSION] - [FEATURE_NAME] Planning

**Version**: [VERSION]
**Feature**: [FEATURE_NAME]
**Status**: Planning
**Date**: [DATE]
**Project**: [PROJECT_NAME]
**Author**: [AUTHOR]

<!-- Example from BookRAG Manager:
Version: v0.9.0
Feature: RAGシステム基盤構築
Status: Planning
Date: 2025-11-15
Project: BookRAG Manager
Author: President
-->

---

## 📋 概要

[OVERVIEW]

<!-- Example:
BookRAG Managerにセマンティック検索およびRAG（Retrieval-Augmented Generation）システムの基盤を構築します。
これにより、ユーザーは書籍を意味的に検索でき、類似書籍の推薦が可能になります。
-->

### 背景

[BACKGROUND]

<!-- Example:
現在のBookRAG Managerは基本的なCRUD機能を提供していますが、ユーザーが書籍を探す際には
タイトルやカテゴリでしか検索できません。ユーザーの検索意図を理解し、意味的に関連する書籍を
提案できるようにすることで、ユーザー体験を大幅に向上させることができます。
-->

### スコープ

#### 含まれるもの
[IN_SCOPE]

<!-- Example:
- Supabase Vector拡張機能の導入
- OpenAI Embeddings APIの統合
- Vector Database層の実装
- RAG検索ロジックの実装
- Similar Books UIの実装
- Semantic Search UIの実装
-->

#### 含まれないもの
[OUT_OF_SCOPE]

<!-- Example:
- 完全なAIチャット機能（将来のフェーズで実装）
- 複数言語対応（現在は日本語のみ）
- リアルタイムストリーミング検索（将来のフェーズで実装）
-->

---

## 🎯 目標

### ビジネス目標

[BUSINESS_GOALS]

<!-- Example:
1. **ユーザー体験の向上**: 意味的検索により、ユーザーが求める書籍を素早く見つけられる
2. **エンゲージメント向上**: 類似書籍推薦により、ユーザーの滞在時間と利用頻度を増加
3. **データベース価値最大化**: 既存の書籍データを活用し、新たな価値を創出
4. **競争優位性**: 他の書籍管理アプリにない差別化機能を提供
-->

### 技術目標

[TECHNICAL_GOALS]

<!-- Example:
1. **Supabase Vector拡張**: pgvector拡張機能を導入し、ベクトル検索基盤を構築
2. **OpenAI統合**: text-embedding-3-smallモデルを使用し、高品質な埋め込みを生成
3. **スケーラブルな設計**: 大量の書籍データに対応できるインデックス設計
4. **TypeScript型安全性**: 全ての新規コードで型安全性を保証
5. **エラーハンドリング**: API障害時のフォールバック機能を実装
-->

### 成功指標

[SUCCESS_METRICS]

<!-- Example:
- **検索精度**: 類似書籍の推薦精度 80%以上（人間評価）
- **レスポンス時間**: セマンティック検索 2秒以内
- **エラー率**: API呼び出しエラー率 1%未満
- **コード品質**: TypeScriptエラー 0件、ビルド成功率 100%
- **DoD達成率**: 全Worker 100%達成
-->

---

## 🏗️ アーキテクチャ

### システム構成図

[ARCHITECTURE_DIAGRAM]

<!-- Example:
```
┌─────────────────────────────────────────────────────────────┐
│                        Frontend (Next.js)                    │
│  ┌──────────────────┐  ┌──────────────────┐                │
│  │ Similar Books UI │  │Semantic Search UI│                │
│  └────────┬─────────┘  └────────┬─────────┘                │
│           │                      │                           │
└───────────┼──────────────────────┼───────────────────────────┘
            │                      │
            v                      v
┌─────────────────────────────────────────────────────────────┐
│                    Business Logic Layer                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              RAG Search Logic (rag-search.ts)        │  │
│  │  - embedQuery(): クエリのベクトル化                 │  │
│  │  - searchSimilarBooks(): 類似書籍検索               │  │
│  │  - rankResults(): 結果のランキング                  │  │
│  └────────────────┬─────────────────────────────────────┘  │
└─────────────────────┼───────────────────────────────────────┘
                      │
                      v
┌─────────────────────────────────────────────────────────────┐
│                    Data Access Layer                         │
│  ┌────────────────────────────────────────────────────┐    │
│  │          Vector Database (vector-db.ts)            │    │
│  │  - matchBooksByEmbedding()                         │    │
│  │  - updateBookEmbedding()                           │    │
│  └──────────────┬─────────────────────────────────────┘    │
│                 │                                            │
│  ┌──────────────┴─────────────────────────────────────┐    │
│  │          Embeddings (embeddings.ts)                │    │
│  │  - createEmbeddingText()                           │    │
│  │  - embedText() → OpenAI API                        │    │
│  │  - embedBook(), embedBooks()                       │    │
│  └──────────────┬─────────────────────────────────────┘    │
└─────────────────┼───────────────────────────────────────────┘
                  │
                  v
┌─────────────────────────────────────────────────────────────┐
│                     External Services                        │
│  ┌─────────────────┐      ┌──────────────────────────┐     │
│  │  Supabase       │      │  OpenAI                  │     │
│  │  - Vector DB    │      │  - Embeddings API        │     │
│  │  - pgvector     │      │  - text-embedding-3-small│     │
│  └─────────────────┘      └──────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
```
-->

### データフロー

[DATA_FLOW]

<!-- Example:
1. **書籍追加フロー**:
   User → BookForm → createBook() → Supabase → embedBook() → OpenAI → updateBookEmbedding() → Supabase

2. **セマンティック検索フロー**:
   User → Search Input → embedQuery() → OpenAI → matchBooksByEmbedding() → Supabase → rankResults() → Display Results

3. **類似書籍表示フロー**:
   Book Detail Page → getSimilarBooks() → matchBooksByEmbedding() → Supabase → Display Similar Books
-->

### 技術スタック

[TECH_STACK_TABLE]

<!-- Example:
| レイヤー | 技術 | バージョン | 用途 |
|---------|-----|----------|------|
| Frontend | Next.js | 14.2.17 | UIフレームワーク |
| Frontend | TypeScript | 5.x | 型安全性 |
| Frontend | React | 18.x | UIライブラリ |
| Backend | Supabase | Latest | データベース |
| Backend | pgvector | Latest | ベクトル検索 |
| AI | OpenAI | 4.x | Embeddings API |
| AI | text-embedding-3-small | - | 埋め込みモデル（1536次元） |
-->

---

## 🛠️ 技術選定

### [TECH_CHOICE_1_NAME]

**選定理由**: [REASON_1]

**バージョン**: [VERSION_1]

**利点**:
- [ADVANTAGE_1]
- [ADVANTAGE_2]
- [ADVANTAGE_3]

**注意点**:
- [CONSIDERATION_1]
- [CONSIDERATION_2]

<!-- Example:
### OpenAI text-embedding-3-small

**選定理由**: 高品質な日本語埋め込みを低コストで生成できる

**バージョン**: Latest (OpenAI SDK 4.x)

**利点**:
- 日本語テキストに対して高品質な埋め込みを生成
- 1536次元で軽量かつ高速
- コストパフォーマンスが高い（$0.00002 per 1K tokens）
- Supabase Vector（pgvector）と相性が良い

**注意点**:
- API呼び出しにレート制限がある（tier-based）
- 環境変数（OPENAI_API_KEY）の管理が必要
- ビルド時エラーを避けるため、Lazy Initializationパターンを使用
-->

### [TECH_CHOICE_2_NAME]

**選定理由**: [REASON_2]

**バージョン**: [VERSION_2]

**利点**:
- [ADVANTAGE_1]
- [ADVANTAGE_2]
- [ADVANTAGE_3]

**注意点**:
- [CONSIDERATION_1]
- [CONSIDERATION_2]

<!-- Example:
### Supabase pgvector

**選定理由**: PostgreSQLベースのVector検索機能を簡単に導入できる

**バージョン**: Latest

**利点**:
- PostgreSQL拡張機能として動作し、既存のSupabaseと統合可能
- ivfflatインデックスで高速な類似度検索が可能
- コサイン類似度、L2距離、内積をサポート
- Supabase Functionsと連携可能

**注意点**:
- インデックス作成には時間がかかる（大量データの場合）
- ベクトル次元数は固定（1536次元）
- マイグレーションファイルでの設定が必要
-->

### [TECH_CHOICE_3_NAME]

**選定理由**: [REASON_3]

**バージョン**: [VERSION_3]

**利点**:
- [ADVANTAGE_1]
- [ADVANTAGE_2]

**注意点**:
- [CONSIDERATION_1]
- [CONSIDERATION_2]

---

## 🚨 Protocol 遵守ガイドライン

本計画を実行する際、以下のプロトコルを必ず遵守すること:

### Boss1の責任
1. ✅ 各Worker指示書に「作業開始前チェックリスト」が記載されていることを確認
2. ✅ Worker完了報告受領時、logs/send_log.txt でagent-send.sh使用を確認
3. ✅ Worker報告内容と実ファイルの整合性を確認（ls -la で検証）

### 全Workerの責任
1. ✅ 作業開始前に pwd で作業ディレクトリ確認
2. ✅ 成果物作成後に ls -la で実在確認
3. ✅ git commit 後に git log -1 --stat で内容確認
4. ✅ 完了報告は agent-send.sh で送信（テキスト応答禁止）

**Protocol Improvement 4 に準拠した実装を行うこと**

---

## 📅 マイルストーン

### Phase 1: 基盤構築 ([PHASE1_DURATION])

**目標**: [PHASE1_GOAL]

**タスク**:
- [TASK_1]
- [TASK_2]
- [TASK_3]

**成果物**:
- [DELIVERABLE_1]
- [DELIVERABLE_2]

<!-- Example:
### Phase 1: 基盤構築 (1日)

**目標**: Supabase Vector拡張とOpenAI Embeddings APIの統合

**タスク**:
- チケット212-A: Supabase Vector設定（Worker1）
- チケット212-B: OpenAI Embeddings API統合（Worker2）

**成果物**:
- supabase/migrations/XXX_add_vector_support.sql
- src/lib/embeddings.ts
-->

---

### Phase 2: データベース層実装 ([PHASE2_DURATION])

**目標**: [PHASE2_GOAL]

**タスク**:
- [TASK_1]
- [TASK_2]

**成果物**:
- [DELIVERABLE_1]
- [DELIVERABLE_2]

<!-- Example:
### Phase 2: データベース層実装 (0.5日)

**目標**: Vector Database層の実装

**タスク**:
- チケット212-C: Vector Database実装（Worker3）

**成果物**:
- src/lib/vector-db.ts
- Supabase RPC関数: match_books_by_embedding
-->

---

### Phase 3: ビジネスロジック実装 ([PHASE3_DURATION])

**目標**: [PHASE3_GOAL]

**タスク**:
- [TASK_1]
- [TASK_2]

**成果物**:
- [DELIVERABLE_1]
- [DELIVERABLE_2]

<!-- Example:
### Phase 3: ビジネスロジック実装 (0.5日)

**目標**: RAG検索ロジックの実装

**タスク**:
- チケット212-D: RAG検索ロジック実装（Worker4）

**成果物**:
- src/lib/rag-search.ts
- searchSimilarBooks(), getSimilarBooks()
-->

---

### Phase 4: UI実装 ([PHASE4_DURATION])

**目標**: [PHASE4_GOAL]

**タスク**:
- [TASK_1]
- [TASK_2]

**成果物**:
- [DELIVERABLE_1]
- [DELIVERABLE_2]

<!-- Example:
### Phase 4: UI実装 (0.5日)

**目標**: Similar BooksとSemantic Search UIの実装

**タスク**:
- チケット212-E: Similar Books UI実装（Worker5）
- チケット212-F: Semantic Search UI実装（Worker6）

**成果物**:
- src/components/SimilarBooks.tsx
- src/components/SemanticSearch.tsx
- src/app/books/[id]/page.tsx（更新）
- src/app/list/page.tsx（更新）
-->

---

## ✅ Definition of Done

### 全体DoD

- [ ] 全Phase完了
- [ ] 全タスク（チケット）完了
- [ ] 全Worker DoD 100%達成
- [ ] TypeScriptエラー: 0件
- [ ] ビルドテスト: 成功
- [ ] 単体テスト: 成功（該当する場合）
- [ ] E2Eテスト: 成功（該当する場合）
- [ ] 動作確認: 完了
- [ ] Git commit & push完了
- [ ] ドキュメント更新完了

### Phase別DoD

#### Phase 1
- [ ] [PHASE1_DOD_1]
- [ ] [PHASE1_DOD_2]

#### Phase 2
- [ ] [PHASE2_DOD_1]
- [ ] [PHASE2_DOD_2]

#### Phase 3
- [ ] [PHASE3_DOD_1]
- [ ] [PHASE3_DOD_2]

#### Phase 4
- [ ] [PHASE4_DOD_1]
- [ ] [PHASE4_DOD_2]

---

## 🧪 テスト戦略

### 単体テスト

[UNIT_TEST_STRATEGY]

<!-- Example:
- embeddings.ts: createEmbeddingText, embedText, embedBookのテスト
- vector-db.ts: matchBooksByEmbeddingのテスト
- rag-search.ts: searchSimilarBooks, rankResultsのテスト
-->

### 統合テスト

[INTEGRATION_TEST_STRATEGY]

<!-- Example:
- Supabase Vector DBとの統合テスト
- OpenAI APIとの統合テスト
- フルフロー（書籍追加→ベクトル化→検索）のテスト
-->

### E2Eテスト

[E2E_TEST_STRATEGY]

<!-- Example:
- Similar Books UIの表示・クリックテスト
- Semantic Search UIの検索・結果表示テスト
- 検索結果の正確性テスト（人間評価）
-->

---

## 📊 リスク管理

### 技術リスク

| リスク | 影響度 | 対策 |
|-------|--------|------|
| [RISK_1] | [IMPACT_1] | [MITIGATION_1] |
| [RISK_2] | [IMPACT_2] | [MITIGATION_2] |
| [RISK_3] | [IMPACT_3] | [MITIGATION_3] |

<!-- Example:
| リスク | 影響度 | 対策 |
|-------|--------|------|
| OpenAI API障害 | 高 | フォールバック機能を実装、キャッシュを活用 |
| Supabase Vector設定失敗 | 高 | マイグレーションをロールバック可能にする |
| 検索精度不足 | 中 | ランキングアルゴリズムを調整可能にする |
| レスポンス時間超過 | 中 | インデックス最適化、クエリ最適化 |
-->

---

## 📚 参考資料

### 公式ドキュメント

- **[DOC_1_NAME]**: [URL_1]
- **[DOC_2_NAME]**: [URL_2]
- **[DOC_3_NAME]**: [URL_3]

<!-- Example:
- **Supabase Vector**: https://supabase.com/docs/guides/ai/vector-columns
- **OpenAI Embeddings**: https://platform.openai.com/docs/guides/embeddings
- **pgvector**: https://github.com/pgvector/pgvector
- **Next.js**: https://nextjs.org/docs
-->

### 関連プロジェクト

- **[PROJECT_1_NAME]**: [DESCRIPTION_1] - [URL_1]
- **[PROJECT_2_NAME]**: [DESCRIPTION_2] - [URL_2]

### 学習リソース

- **[RESOURCE_1_NAME]**: [DESCRIPTION_1] - [URL_1]
- **[RESOURCE_2_NAME]**: [DESCRIPTION_2] - [URL_2]

---

## 🎯 次のステップ

[NEXT_STEPS]

<!-- Example:
1. President がチケット212を作成し、Boss1に送信
2. Boss1 がチケット212を分析し、6 Workersに分解
3. Boss1 が各Worker向け指示書を作成
4. Tier1（Worker1, Worker2）を並列で開始
5. Tier2（Worker3）、Tier3（Worker4）、Tier4（Worker5, Worker6）を順次実行
6. Boss1 が統合作業・テスト・Git管理を実施
7. Boss1 が President に完了報告を送信
-->

---

**このPlanning Documentは、[PROJECT_NAME]の[FEATURE_NAME]実装における全体像を示しています。**

**Protocol Improvement 3に従い、全Worker DoD 100%達成を目指します。**

---

<!-- BookRAG Manager実例 -->
<!--
実例: v0.9.0 - RAGシステム基盤構築 Planning

Project: BookRAG Manager
Version: v0.9.0
Feature: RAGシステム基盤構築
Date: 2025-11-15

Phase Structure:
- Phase 1: 基盤構築（Supabase Vector + OpenAI Embeddings）
- Phase 2: データベース層実装（Vector DB）
- Phase 3: ビジネスロジック実装（RAG検索）
- Phase 4: UI実装（Similar Books + Semantic Search）

Workers: 6 Workers
Tier Structure: 4 Tiers
Duration: 1-2日（実際は1日で完了）
DoD Achievement: 100%
TypeScript Errors: 0
Build: Success
Protocol Success: 11連続成功達成

この計画に基づき、チケット212が作成され、Protocol Improvement 3により
11連続成功を達成しました。
-->
