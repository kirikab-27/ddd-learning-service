ドメイン駆動設計まあ ddd について学び始めると不思議とすぐアーキテクチャーの話になりますよね なりますね僕も最初はあれって ddd ってもっとこうビジネスの革新を探るなんていうか泥臭い話じゃなかったっ けってちょっと混乱したんですよわかりますでもあなたが共有してくれた資料を読んで その理由が少し見えてきました 今日はですねアーキテクチャーは主役じゃないっていう一見逆説的な言葉をテーマにして みたいんですいいですね なぜ ddd にとってアーキテクチャーがまあ最高の相棒なのか その関係性を深く探っていければなと それはすごく重要な視点だと思います主役じゃないけど不可欠な存在 まるで映画のえっと優れた脚本とか舞台装置みたいなものなんですよ なるほどそれ自体が目立つわけじゃないでもそれがないと物語 つまりドメインが輝かないんです 今日はその舞台装置がどうやってドメインモデルっていう主役を守って ソフトウェア全体の価値を長く保つのかじっくり話していきましょうか 整備お願いしますではまずこういう舞台装置は最悪だっていう例から 資料にある利好な ui という言葉 はいこれなんかドキッとしますね 正直なところ開発現場で高納期に追われていると一旦 ui 側で計算しちゃおうみたいな誘惑に 駆られること僕もあるんですよ 痛いほどわかりますその誘惑この手っ取り早さが具体的にどういう技術的不採に つながっていくんでしょうか 8ですね例えば資料にあった ec サイトの例がわかりやすいですよね 注文確認画面とか注文履歴画面で合計金額を表示したいと一番簡単なのはそれぞれの 画面を表示するプログラムの中で商品の単価と数量を掛け合わせて 送料を足してって計算することじゃないですか そうですねやってしまいがちですこれがまさに 利効な ui の正体なんです 本来ドメインつまりビジネスルールの中心が担うべき合計金額を計算するっていうロジック が ui っていう末端に漏れ出してしまっている状態 なるほど その場しのぎとしてはすごく魅力的なんですけど後で必ずつけを払わされるパターンですね これはまさしく しかもそのつけはふくりで膨らんでいくんです 大きな問題は2つあって一つは使用変更にすごく弱い 例えば税率が変わりますとか特定の条件で送料が無料になりますってなった時 本来一箇所直せばいいはずのロジックが3つの画面に散らばっているせいで 3つの画面に全部忘れずに直さないといけないそれは単純に手間も増えますし 修正漏れっていう一番怖いバグの温床になりますよねそうなんです いやーその高度の分岐は本当に恐ろしいですよね 僕も以前あるプロジェクトで同じような割引計算が3箇所にあって 使用変更で2箇所は直したのに1箇所見逃してて大問題になったという苦い記憶があります それは大変な経験でしたね まさにシェアローにあった誰も触れない複雑怪奇なコードになってて もう触るのが怖いっていう状態で ええでそれがもう一つのもっと深刻な問題につながるんですよ と言いましと最初は同じだったはずのロジックがそれぞれの画面の都合でこっちの画面では手数量 先に計算してとかあっちはポイント割引を後で引いてとか 微妙にカスタマイズされていくんです あー足が生まれていくわけですねそうです その足たちが気づいた頃には誰にも全体像がわからないモンスターを生み出してしまう 結局利効な ui って短期的な利益のために未来の選択肢を売り払っているようなもん なんですよ 未来の選択肢をエアーキテクチャーはその未来の選択肢 つまり変更する自由を守るための保険とも言えるかもしれないですね 未来の選択肢を守るための保険ですかああそれはすごく負に落ちる方言です つまり個々の開発者の今回は特別だからとか 後でリファクタリングするからっていう善意とか自精神に頼るんじゃなくてそうそう 仕組みとしてビジネスロジックはここに書きなさいと導く方針 それがアーキテクチャーの役割なんだとお見事ですそれが本質ですね ddd がアーキテクチャーに求めることって突き詰めればたった一つなんです たった一つ ドメインオブジェクトが渦巻くレイヤーを隔離して ui とかデータベース2階なソフトウェア固有の事情から防衛する これさえ達成できれば極論名前は何でもいいんです なるほど この明確な方針があるからこそ開発者はこの処理どこに囲うっていう迷いから解放されて 本来向き合うべきドメインの複雑さに集中できるわけです なるほどドメインの隔離と防衛が目的なんですね それを理解した上でじゃあ具体的な尖閣寺を見ていきたいなぁと資料には代表的なもの が3つ挙げられてますよねはい まずは一番伝統的なレイヤードアーキテクチャーからいきましょうか これはどういう考え方なんでしょうはい レイヤードアーキテクチャーはその名の通り ソフトウェアの関心語と層レイヤーで分割する考え方ですね 資料だと代表的な4層構造プレゼンテーション層 アプリケーション層ドメイン層インフラストラクチャー層が紹介されています はいで重要なルールは依存の方向が原則として上から下への一方通行であること プレゼンテーション層はアプリケーション層に依存できるけど ドメイン層がプレゼンテーションの存在を知っちゃいけないみたいな決まりです これによってビジネスルールを純粋に保つドメイン層が他の層の都合から守られるという わけですね 役割を層で完全に分けるとプレゼンテーション層が ui でインフラストラクチャー層がデータベースっていうのはイメージしやすい ですそうなるとその中間にいるアプリケーション層がいわば全体の交通整理役というか オーケストラの指揮者みたいな役割を担うという理解であってますか を的確な比喩ですねまさに指揮者です ああそうですかアプリケーション層はドメインの個々のオブジェクト まあ演奏者たちにビジネスルールそのものを教えたりはしないんですはい 代わりにユーザーを登録するっていう一つのユースケース つまり楽曲ですねこれを実現するためにユーザーっていうエンティティを生成してリポジトリに 永続化を依頼してみたいな一連のタスクの流れを管理 つまり指揮するんですなるほどあくまでドメインオブジェクトのクライアントとして振る舞う それがアプリケーション層の役割です なるほどなぁ レイヤードが上下の階層で関心ことを分離するのに対して資料を見ると次は内外っていう また違った切り口の考え方があるんですね ヘキサゴナルアーキテクチャー このゲーム機の例えすごく面白いんですけどどういうことなんですか ヘキサゴナルアーキテクチャー別名ポートアンドアダプターの革新はアプリケーションのコア つまりビジネスロジックを内側において ui とかデートベースみたいな外部要員を外側に配置して両者を完全に 切り離すっていう発想です ふむふむまさにおっしゃる通りゲーム機本体とコントローラーとかテレビの関係ですよ ゲーム機本体って特定のメーカーのコントローラーに依存してないじゃないですか 確かに決められた接続端子つまりポートさえあっていればどんなメーカーのコントローラー つまりアダプターでも接続して遊べる この付け替え可能な点がミソなんです あーなるほどアプリケーションのコアがディーム基本体でウェブからのリクエストとかデータベースへの保存という具体的な技術がコントローラーとかテレビに当たるわけですね その通りですそれらをポートっていう企画とアダプターっていう実装で接続すると そうなんです アプリケーションのコアは注文を受け付けるとか商品情報を取得するみたいな抽象的なポート java とかでいうインターフェースですねこれを定義します で web フレームワークとかデータベースのライブラリーはそのポートに接続するための具体的な実装である アダプターとして作る これによって例えば webui をコンソールアプリに mysql をポストグレスキュールに入れ替えてもアプリケーションのコアは一切変更する必要がなくなる この独立性がテストのしやすさとか技術の進化への追従性を格段に高めるんです でもあの資料の法則にレイヤードアーキテクチャーでも依存関係逆転の原則を 使えば同じことが実現できるとありますねこれはどういうことでしょう あ良いところに気づきましたねこれは少し発展的な話ですけどはい さっきのレイヤードアーキテクチャーで上位のアプリケーション層が 回のインフラスラクチャー層に直接依存するんじゃなくて両方がドメイン層で定義された インターフェース つまり抽象に依存する形にするんですああなるほど こうすることでインフラ層をヘキサゴラムアダプターみたいに簡単に入れ替えられるようになる 結果として現代的なレイヤードアーキテクチャーとヘキサゴナルアーキテクチャーの境界っていうのは かなり曖昧になってきているって言いますね面白いですね では最後にクリーンアーキテクチャーあの同心園の図がすごく印象的です これも目指すところは同じですかはい思想的な根っこはヘキサゴなんぞほぼ同じです 関心の分類を徹底してビジネスルールを園の中心にある最も重要なものとして保護する ふむ依存性のルールも同じで外側の縁は内側の縁にしか依存できない つまり ui とかデータベースみたいな具体的な詳細が中心にあるビジネスルール っていう抽象に依存する形をより厳格に強制するんです ではヘキサゴナルとの違いはどこにあるんでしょう 一番の違いはそのコンセプトを実現するためのより具体的でなんていうか 規範的な実装方法にまで言及している点ですかね 例えば個々のユースケースをカクセル化するインタラクターとか データのやり取りを担う協会としてのポート 表示形式を整えるプレゼンターみたいなより具体的な役割名が定義されてたりします なるほど あとはあらゆるものがテスト可能であるべきだ っていうテスタビリティへの強いこだわりもクリーンアーキテクチャーの大きな特徴と言える でしょうね ここまで3つのアーキテクチャーを見てきましたけど結局のところすべてはドメインの隔離 っていう同じ山を違うルートから登っているように見えますね まさにレイヤードはそうっていう垂直な分離 ヘキサゴナルは内外の水平な分離 クリーンは中心と周辺という球心的な分離 表現は違えど目指す調和は同じなんだなぁと 全くその通りです素晴らしい要約ですね いえいえ そしてこれらのアーキテクチャーがもたらす最大の価値は資料の言葉を借りるなら一度に多くのことを考え なくて済むようにすることなんです 人間てマルチタスクが苦手な生き物じゃないですか はい苦手ですアーキテクチャーという地図とコンパスがあることで ui のボタンの色を考えているときは複雑な割引計算のことは忘れられる ビジネスロジックを実装しているときはデータベースにどうやって保存するか みたいな詳細は考えなくて済む 関心事を綺麗に分離してくれるんです なるほどその結果開発者は最も重要で最も脳のメモリーを消費すべき ドメインモデルの探求により多くの時間とエネルギーを割くことができるというわけ ですね まさしくだから ddd とアーキテクチャーは切っても切れない関係にあるんだ それこそが ddd においてアーキテクチャーが重要視される たった一つのしかし最も重要な理由なんですではこれをリスナーであるあなたへの メッセージとして言い換えるとこういうことでしょうか あなたがコードを読んだり書いたりするときにこのアーキテクチャーという地図があれば 今自分が考えるべきことは何かそして今は考える必要がないことは何かが明確になる それによって思考が迷子にならずに本当に重要な本質的な作業に深く集中できる ということですね 完璧なまとめですまさにその通りです さて今回の話を整理してみましょうか まず ddd においてアーキテクチャーは主役ではないけれど ドメインという主役を隔離して防衛するという不可欠な役割を担っていること はい次にビジネスロジックが ui に漏れ出す 利効な ui は短期的な落差の代償として変更する自由を奪う危険なアンチパターンである ことそしてレイヤードヘキサゴなるクリーンといったアーキテクチャーは表現こそ違えど 関心の分離とドメインの保護という共通の頂点を目指していること このあたりが今日の確信でしたねはいでは最後にあなたがさらに思考を深めるための 問いを一つ投げかけたいと思います お願いします資料は利用者が必要とすることを満たすのが最も重要だと締めくくっています ではここから一歩踏み込んで考えてみましょう プロジェクトの本当に初期の段階 まだドメインの姿さえ曖昧で何を作るべきかを探求しているフェーズにおいて 厳格なアーキテクチャーを導入することはその発見のプロセスを助けるでしょうか それとも妨げるでしょうか なるほどアーキテクチャーを導入するためのコストがそれがもたらす価値を上回るのはどのタイミングなのか この問いに唯一の正解はありません あなたのプロジェクトの文脈で考えてみる価値は大いにあると思います