こんにちはさて今回はナルセユツノベンさんの著書ドメイン駆動設計入門 ボトムアップでわかるドメイン駆動設計の基本を一緒に読み解いていきたいと思います はいあの複雑なソフトウェア開発の課題を解決する手法 ドメイン駆動設計 まあDDDですよね言葉は聞いたことあるけどなんか専門用語のオンパレードで どこから手をつければいいのかって圧倒されているそんなあなたのための時間です この本面白いのがDDDっていう巨大なテーマに正面からじゃなくて なぜ多くの書学者はDDDに打ちのめされるのかっていう これ問いから入っている点なんですよね 著者はその原因を多様な専門用語だと言い切ってて それを幽霊に例えてるんです 幽霊ですか確かにエンティティだのネオブジェクトだの ユビキタス言語だの知らない言葉が並ぶとそれだけでもう怖すぎちゃいますよね まさにでも著者は言うんですよ 幽霊の正体見たり枯れを花だとなるほど正体がわからないから怖いだけで一つ一つ 正体を確かめていけばそれはもうただの便利な道具にすぎないと面白いですね なので今回の分析ではこの本に沿ってその幽霊たちの正体を一つずつ暴いていこうかなと いいですね幽霊退治始めましょうか 本書はオブジェクト思考の基本知識がある開発者向けで サンプルコードは c シャープですけど他の言語の経験者でも問題なく読めるように配慮されてますね そうなんですその準備体操は本に任せるとしてはい 早速最初の幽霊の正体に迫りたいと思います まず基本となる値オブジェクト 正直僕も昔はこれただの数値とか文字列と何が違うんだって思ってたんですよ あー非常に良いポイントですね 値オブジェクトの革新て単に変更不可能 イミュータブルであるっていうルールだけじゃないんです これが解決してくる開発者が日常的に直面するこう 厄介な問題があるんですよね例えばある場所で商品の価格を変更したら全く意図しない別の 場所の計算まで狂っちゃった みたいな経験ありませんかああ 痛いほどありますあります変数が何かあちこちで使い回されててどこで値が 変わったのか追うのが地獄みたいな ですよね 値オブジェクトはまさにその問題に対する処方箋なんです処方箋 価格を単なる数字じゃなくて プライスっていう変更不可能のオブジェクトとして扱う そうするとシステムは価格を提案じゃなくて事実として扱わざるを得なくなるんです なるほど意図しない副作用で値が書き換わるっていう バグのクラスを丸ごと一つ消し去ることができる これはシステムの安全性を劇的に高めるための最初のそして最も重要な一歩と言えますね あーなるほど ただのルールじゃなくてバグを未然に防ぐための思考の道具なんですね 幽霊の正体がちょっと見えてきました でも世の中には値のように扱えないものもありますよね 例えば顧客とかそうですね住所が変わっても電話番号が変わってもその人は同じ顧客じゃない ですか こういう歴史を持つものはどう扱うんでしょう そこに出てくるのがもう一体の基本的な幽霊エンティティーです エンティティーはい値オブジェクトがその性質によって定義されるのに対して エンティティーはライフサイクルを通じて一貫した同一性によって定義されます 同一性重要なのは可変であること 状態は変わるけれど id によって同じものであると追跡され続ける存在 まさにあなたが言った顧客や商品がこれに当たります ok です 性質で定義される値オブジェクトと同一性で定義されるエンティティー この2つがデータを表現するための基本的な部品ということですね その通りですでも実際のシステムってこれらの部品がバラバラに存在しているわけじゃない ですよね 例えば ec サイトの注文を考えると注文明細とか配送先住所とかが複雑に絡んで くる 以前注文明細の数量だけ変えたら合計金額が更新されなくて大問題になったことがあり ました こういう整合性ってどう守ればいいんでしょう 素晴らしいまさに ddd が本領を発揮する革新部分です 個別の部分だけ見ていてもシステム全体の複雑さは解決できないんですよ はいそこで登場するのがこの本で最も重要な概念の一つ 集約アグリゲートですね集約 これは関連するエンティティと値オブジェクトをまとめ上げて 一貫性を守るためのまあ保護バブルというか 教会のようなものです保護バブルですか a さっきの注文の例で言えば注文が集約のルートになります その中に注文明細のリストとか配送先住所が含まれる で外部の世界からいきなり中の注文明細の数量だけを勝手に書き換えることは許されないんです ああなるほど必ず注文というバブルの入り口を通して 明細の数量を変更するという操作を依頼する そうすると注文オブジェクトが責任を持って数量の変更と合計金額の再計算という 一連のビジネスルールを矛盾なく実行してくれるんです これによりあなたが経験したようなデータの不整合をもう構造的に防ぐことができる わけです なるほど集約はビジネスルールを守るための番人なんですね バラバラだった部品がこれで一つの意味ある塊になった感じがします でもその注文集約を作るのって結構大変そうですよね 在庫を確認したり顧客情報を検証したり その通りです オブジェクトの生成ロジックが複雑になることはまあよくありますからね はい その複雑さをエンティティ自身に全部背負わせるとオブジェクトがどんどん非大化しちゃう そこで登場するのがファクトリーです ファクトリー はいこれは複雑なオブジェクトを生成することに特化した いわば専門の組み立てラインですね 関心ごとを分離して高度の見通しを良くするためのパターンです 組み立てラインわかりやすいです さてこれでビジネスルールを守る塊 つまり集約を専門のラインであるファクトリーで作れるようになりましたと そうですね 次はこの塊をデータベースに保存したり そこから取り出したりする必要がありますよね 僕の経験だとここの処理が一番厄介で あーわかります ビジネスロジックのコードの中に SQL の断片が散らばっちゃって もうテストもできないカオスな状況になりがちなんですけど それも開発現場でよく聞く悲鳴ですね そのカオスに対する DDD の答えがリポジトリーです リポジトリー はいリポジトリーはドメインモデル つまりビジネスロジックとデータ永続化の技術的な詳細との間に 分厚に壁を築いてくれる存在なんです 壁ですか? ええビジネスロジックを考える側から見ると まるでオブジェクトがメモリ上のコレクションに入っているかのように振る舞ってくれる データベースが SQL サーバーなのかファイルなのかといった どうやって保存するかっていうそういう面倒な詳細は リポジトリーが全部隠蔽してくれるんですよ つまりビジネスロジックをインフラの都合から完全に守ってくれるファイアウォール というわけですね まさに これでテストもしやすくなる だんだん幽霊たちが実は頼もしい仲間に見えてきました まさに個別の問題を解決してくれる頼れる専門家たちなんです ただもう一つスッキリしないことがあるんです と言いますと 例えば銀行口座間の送金みたいな処理 これって送金元口座の仕事でも送金先口座の仕事でもないような気がするんです ああなるほどどちらかに無理やり実装するとなんだか不自然な設計になる こういうどのオブジェクトにも属さないような振る舞いってどこに行けばいいんでしょう 完璧な質問ですそれとそが最後の幽霊 ドメインサービスが解決する不自然さなんですよ ドメインサービス ある重要なビジネスプロセスが特定のエンティティや値オブジェクトの責務として表現するのが不自然な場合 その操作自体を一つの独立したサービスとして定義する それがドメインサービスです 複数の集約にまたがるような操作を調整する役割を担うことが多いですね これで設計の不自然さを解消してビジネスのプロセスを素直に高度に落とし込むことが できるようになります なるほどこれで値オブジェクトエンティティ集約ファクトリー リポジトリドメインサービスと幽霊たちの正体はだいたい見えました はい僕の中ではこれらを使ってかなり整理されたシステムが作れるイメージが湧いて きました でもこの本の最終章のタイトルがドメイン駆動設計の扉を開こう なんですよね まるでここまでの話はすべて準備運動だったと言わんばかりですが 一体本当のゴールは何なんですか そこがこの本の最も伝えたいメッセージなんです これまで見てきたパターンはあくまで優れたソフトウェアを構築するための語彙とか 文法にすぎないと語彙や文法 ddd が本当に目指しているのはこれらの道具を使ってあるものを構築すること それが指きたす言語です指きたす言語必ず出てくるキーワードですけど正直一番 つかみどころがない幽霊です 指きたす言語っていうのは単にネーミングをわかりやすくしましょうっていう話じゃないんですよ ほう開発者とそのビジネスの専門家ドメインエクスパートが日常の会話で使う言葉と ソフトウェアモデルで使う言葉を完全に一致させるというもっとラディカルな考え方なんです 完全に a ビジネスの現場でプレミアム顧客が商品を緊急注文した場合 在庫引当を優先するという会話がされたなら コードにもプレミアムカスタマーやアージェントオーダーといったオブジェクトがあって プライオリタイズストックアロケーションといったメソッドが存在する そのレベルでの一致を目指すんですそれはすごいですね ビジネスのルールがそのままコードの構造になる そうその共有された言語を磨き上げることこそが ddd の真の目的なんですなるほどそうすれば 開発者はビジネスの要求を誤解なく高度に反映できるしビジネスの専門家は コードモデルを見てそれがビジネスルールを正しく表現しているか検証できる この本で学んだパターンはすべて この指きたつ言語というチーム全員が理解できる共通言語 コードという形で有便に語らせるための土台作りなんですね 今回の分析をまとめてみましょうか ドメイン駆動設計入門は ddd という巨大なテーマに対してまず具体的なパターンという道具を 一つ一つ手を渡してくれる そしてそれらが単なる技術テクニックではなく ソフトウェアの複雑さと戦うための思考の道具であることを教えてくれました 幽霊だと思ってた専門用語たちは正体を知れば ビジネスの問題を解き明かすための頼もしい仲間だったということですね まさにその通りですこの本が目指すのはパターンを実践すること自体ではなくて それを通じてソフトウェアで表現すべきビジネスの本質 つまりドメインをより深くモデリングできるようになることですはい さて最後にあなたに思考を投げかけたいと思います お願いしますあなたが今関わっているプロジェクトの高度の一部を少し思い浮かべてみて くださいはい そしてその行動チームの非エンジニア例えば企画担当者とか営業担当者に声に出して 読んで聞かせるところを想像してほしいんです ふむふむその高度は彼らが理解できる物語を語っているでしょうか もし語れていないとしたら今日話した幽霊たち 例えば本来あるべき価格という値オブジェクトや守られるべき注文という集約がそこにない からかもしれません ああ あなたの高度のどこに彼らを招待すればもっとビジネスの物語が明確になるか少し考えて みてください それが ddd の扉を開く本当の第一歩になるはずです
